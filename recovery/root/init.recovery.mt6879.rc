# init.recovery.mt6879.rc
# Main recovery init for Motorola Edge 40 Neo (manaus) - MT6879

import /init.recovery.usb.rc

on early-init
    # Set up recovery environment
    export ANDROID_ROOT /system_root
    export ANDROID_DATA /data
    export EXTERNAL_STORAGE /sdcard
    
    # Create necessary directories
    mkdir /dev/block 0755 root root
    mkdir /dev/block/platform 0755 root root
    mkdir /dev/block/platform/bootdevice 0755 root root
    mkdir /dev/block/platform/bootdevice/by-name 0755 root root
    
    # Symlinks for compatibility
    symlink /dev/block/platform/bootdevice /dev/block/bootdevice
    
    # Create mount points
    mkdir /metadata 0771 root root
    mkdir /data 0771 root root
    mkdir /sdcard 0771 root root
    mkdir /external_sd 0771 root root
    mkdir /usb_otg 0771 root root
    mkdir /tmp 0775 root shell
    
    # Framebuffer permissions - CRITICAL FOR DISPLAY
    chown root root /dev/graphics/fb0
    chmod 0666 /dev/graphics/fb0
    
    # Backlight
    chown root root /sys/class/leds/lcd-backlight/brightness
    chmod 0666 /sys/class/leds/lcd-backlight/brightness
    chown root root /sys/class/backlight/panel0-backlight/brightness
    chmod 0666 /sys/class/backlight/panel0-backlight/brightness

on init
    # Device properties
    setprop ro.hardware mt6879
    setprop ro.hardware.platform mt6879
    setprop ro.board.platform mt6879
    setprop ro.product.board mt6879
    
    # Recovery
    setprop ro.build.product manaus
    setprop ro.product.device manaus
    setprop ro.product.name manaus
    
    # Debug
    setprop ro.debuggable 1
    setprop ro.secure 0
    setprop ro.adb.secure 0
    
    # TWRP
    setprop ro.twrp.boot true
    setprop ro.twrp.version 3.7.0_12
    
    # MediaTek
    setprop ro.mediatek.platform MT6879
    
    # Disable verified boot checks
    setprop ro.boot.verifiedbootstate orange
    setprop ro.boot.vbmeta.device_state unlocked

on fs
    # Mount metadata
    mount ext4 /dev/block/by-name/metadata /metadata rw nosuid nodev noatime
    
    # Try to mount data (may fail if encrypted - that's OK)
    mount f2fs /dev/block/by-name/userdata /data rw nosuid nodev noatime || \
    mount ext4 /dev/block/by-name/userdata /data rw nosuid nodev noatime || \
    echo "Data mount failed (expected if encrypted)"

on post-fs
    # Symlinks for dynamic partitions
    symlink /dev/block/mapper/system /dev/block/system
    symlink /dev/block/mapper/vendor /dev/block/vendor
    symlink /dev/block/mapper/product /dev/block/product
    symlink /dev/block/mapper/system_ext /dev/block/system_ext

on boot
    # Input
    chown root root /dev/input/event*
    chmod 0666 /dev/input/event*
    
    # Uinput
    chown root root /dev/uinput
    chmod 0666 /dev/uinput
    
    # LEDs
    chown root root /sys/class/leds/*/brightness
    chmod 0666 /sys/class/leds/*/brightness
    
    # Battery
    chown root root /sys/class/power_supply/battery/capacity
    chmod 0444 /sys/class/power_supply/battery/capacity
    
    # Force backlight on
    write /sys/class/leds/lcd-backlight/brightness 1200
    
    # Start ADB
    start adbd

service adbd /system/bin/adbd --root_seclabel=u:r:su:s0
    class core
    socket adbd stream 660 root system
    disabled
    seclabel u:r:adbd:s0

service recovery /system/bin/recovery
    socket recovery stream 422 system system
    seclabel u:r:recovery:s0
